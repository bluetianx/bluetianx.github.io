<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>深入理解Aspnet Core之Identity(3) | Hello,晓青</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="主题 账户管理一个比较常见的功能就是密码强度策略，Identity已经内置了一个通用的可配置的策略，我们一般情况下可以直接拿来用即可。本篇我会介绍一些Identity内置的密码策略类：PasswordValidator，并且简单介绍一下源码。最好我们还会自定义一个密码策略类的实现。  密码强度配置我们需要在startup类里面配置，密码强度策略。代码如下1234567891011121314151">
<meta name="keywords" content="Asp.net core Identity">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解Aspnet Core之Identity(3)">
<meta property="og:url" content="https://github.com/bluetianx/2018/04/07/Identity3/index.html">
<meta property="og:site_name" content="Hello,晓青">
<meta property="og:description" content="主题 账户管理一个比较常见的功能就是密码强度策略，Identity已经内置了一个通用的可配置的策略，我们一般情况下可以直接拿来用即可。本篇我会介绍一些Identity内置的密码策略类：PasswordValidator，并且简单介绍一下源码。最好我们还会自定义一个密码策略类的实现。  密码强度配置我们需要在startup类里面配置，密码强度策略。代码如下1234567891011121314151">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-04-07T08:55:39.887Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入理解Aspnet Core之Identity(3)">
<meta name="twitter:description" content="主题 账户管理一个比较常见的功能就是密码强度策略，Identity已经内置了一个通用的可配置的策略，我们一般情况下可以直接拿来用即可。本篇我会介绍一些Identity内置的密码策略类：PasswordValidator，并且简单介绍一下源码。最好我们还会自定义一个密码策略类的实现。  密码强度配置我们需要在startup类里面配置，密码强度策略。代码如下1234567891011121314151">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hello,晓青</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">我思故我在</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="https://github.com/bluetianx">Github</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/bluetianx"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Identity3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/07/Identity3/" class="article-date">
  <time datetime="2018-04-07T06:53:41.000Z" itemprop="datePublished">2018-04-07</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Asp-net-Core/">Asp.net Core</a>
  </div>

  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 class="article-title" itemprop="name">
      深入理解Aspnet Core之Identity(3)
    </h1>
  

        </header>
        
          <div class="article-entry" itemprop="articleBody">
            
                      <h3 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h3><p> 账户管理一个比较常见的功能就是密码强度策略，Identity已经内置了一个通用的可配置的策略，我们一般情况下可以直接拿来用即可。本篇我会介绍一些<br>Identity内置的密码策略类：PasswordValidator，并且简单介绍一下源码。最好我们还会自定义一个密码策略类的实现。</p>
<hr>
<h3 id="密码强度配置"><a href="#密码强度配置" class="headerlink" title="密码强度配置"></a>密码强度配置</h3><p>我们需要在startup类里面配置，密码强度策略。代码如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void ConfigureServices(IServiceCollection services)</span><br><span class="line">        &#123;</span><br><span class="line">            services.AddDbContext&lt;AppIdentityDbContext&gt;(options =&gt;</span><br><span class="line">                options.UseSqlServer(</span><br><span class="line">                    Configuration[&quot;Data:AppStoreIdentity:ConnectionString&quot;]));</span><br><span class="line">            //配置密码强度</span><br><span class="line">            services.AddIdentity&lt;AppUser, IdentityRole&gt;(opts =&gt; &#123;</span><br><span class="line">                    opts.Password.RequiredLength = 6;</span><br><span class="line">                    opts.Password.RequireNonAlphanumeric = false;</span><br><span class="line">                    opts.Password.RequireLowercase = false;</span><br><span class="line">                    opts.Password.RequireUppercase = false;</span><br><span class="line">                    opts.Password.RequireDigit = false;</span><br><span class="line">                &#125;).AddEntityFrameworkStores&lt;AppIdentityDbContext&gt;()</span><br><span class="line">                .AddDefaultTokenProviders();</span><br><span class="line">            services.AddMvc();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>这个 AddIdentity 方法接受一个 IdentityOptions 对象参数，这个对象包含了所有能用于配置Identity系统的配置项，其中就包含了密码强度的配置。PassWord属性包含了可用于密码强度的配置项，其中包括：</p>
<ul>
<li>RequiredLength ：这个属性用于指明密码的最小长度，类型 int</li>
<li>RequireNonAlphanumeric ：类型：bool，true代表密码至少包含一个非字母或者数字的字符，比如 ！@#</li>
<li>RequireLowercase ：类型bool，true代表密码至少包含一个小写字母</li>
<li>RequireUppercase ：类型 bool，true 代表密码至少包含一个大写字母</li>
<li>RequireDigit ：类型 bool，true 代表密码至少包含一个数字<br>这里我配置的密码强度是不少于六位的字符即可。<h3 id="IdentityOptions-类可用于配置的属性"><a href="#IdentityOptions-类可用于配置的属性" class="headerlink" title="IdentityOptions 类可用于配置的属性"></a>IdentityOptions 类可用于配置的属性</h3>在这里我们把IdentityOptions对应的源代码展现给大家，让大家了解一下哪些可用于配置Identity，<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">    /// Represents all the options you can use to configure the identity system.</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class IdentityOptions</span><br><span class="line">    &#123;</span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Gets or sets the &lt;see cref=&quot;ClaimsIdentityOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;value&gt;</span><br><span class="line">        /// The &lt;see cref=&quot;ClaimsIdentityOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/value&gt;</span><br><span class="line">        public ClaimsIdentityOptions ClaimsIdentity &#123; get; set; &#125; = new ClaimsIdentityOptions();</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Gets or sets the &lt;see cref=&quot;UserOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;value&gt;</span><br><span class="line">        /// The &lt;see cref=&quot;UserOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/value&gt;</span><br><span class="line">        public UserOptions User &#123; get; set; &#125; = new UserOptions();</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Gets or sets the &lt;see cref=&quot;PasswordOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;value&gt;</span><br><span class="line">        /// The &lt;see cref=&quot;PasswordOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/value&gt;</span><br><span class="line">        public PasswordOptions Password &#123; get; set; &#125; = new PasswordOptions();</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Gets or sets the &lt;see cref=&quot;LockoutOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;value&gt;</span><br><span class="line">        /// The &lt;see cref=&quot;LockoutOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/value&gt;</span><br><span class="line">        public LockoutOptions Lockout &#123; get; set; &#125; = new LockoutOptions();</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Gets or sets the &lt;see cref=&quot;SignInOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;value&gt;</span><br><span class="line">        /// The &lt;see cref=&quot;SignInOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/value&gt;</span><br><span class="line">        public SignInOptions SignIn &#123; get; set; &#125; = new SignInOptions();</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Gets or sets the &lt;see cref=&quot;TokenOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;value&gt;</span><br><span class="line">        /// The &lt;see cref=&quot;TokenOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/value&gt;</span><br><span class="line">        public TokenOptions Tokens &#123; get; set; &#125; = new TokenOptions();</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Gets or sets the &lt;see cref=&quot;StoreOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;value&gt;</span><br><span class="line">        /// The &lt;see cref=&quot;StoreOptions&quot;/&gt; for the identity system.</span><br><span class="line">        /// &lt;/value&gt;</span><br><span class="line">        public StoreOptions Stores &#123; get; set; &#125; = new StoreOptions();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>我们除了可以用 IdentityOptions 配置密码策略，还可以用于配置 持久化配置StoreOptions，令牌配置TokenOption等；</p>
<hr>
<h3 id="自定义实现IPasswordValidator"><a href="#自定义实现IPasswordValidator" class="headerlink" title="自定义实现IPasswordValidator"></a>自定义实现IPasswordValidator</h3><ul>
<li>我们首先看一下 IPasswordValidator 接口的定义；</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// Copyright (c) .NET Foundation. All rights reserved.</span><br><span class="line">// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.</span><br><span class="line"></span><br><span class="line">using System.Threading;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line">namespace Microsoft.AspNetCore.Identity</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// Provides an abstraction for validating passwords.</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;typeparam name=&quot;TUser&quot;&gt;The type that represents a user.&lt;/typeparam&gt;</span><br><span class="line">    public interface IPasswordValidator&lt;TUser&gt; where TUser : class</span><br><span class="line">    &#123;</span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Validates a password as an asynchronous operation.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;manager&quot;&gt;The &lt;see cref=&quot;UserManager&#123;TUser&#125;&quot;/&gt; to retrieve the &lt;paramref name=&quot;user&quot;/&gt; properties from.&lt;/param&gt;</span><br><span class="line">        /// &lt;param name=&quot;user&quot;&gt;The user whose password should be validated.&lt;/param&gt;</span><br><span class="line">        /// &lt;param name=&quot;password&quot;&gt;The password supplied for validation&lt;/param&gt;</span><br><span class="line">        /// &lt;returns&gt;The task object representing the asynchronous operation.&lt;/returns&gt;</span><br><span class="line">        Task&lt;IdentityResult&gt; ValidateAsync(UserManager&lt;TUser&gt; manager, TUser user, string password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个接口接受一个泛型T，这个T是应用指定的用户类User，这里我们是 AppUser类。这个接口包含类一个方法 ValidateAsync，这是一个异步方法，用于验证密码是否符合策略。这个方法返回 IdentityResult 类，假如验证没有问题，你可以用静态的IdentityResult.Success属性返回该对象，反之，用Failed静态属性返回。</p>
<ul>
<li>现在我们去了解一下IPasswordValidator接口的默认实现，先附上源代码<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">// Copyright (c) .NET Foundation. All rights reserved.</span><br><span class="line">// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.</span><br><span class="line"></span><br><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line">namespace Microsoft.AspNetCore.Identity</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// Provides the default password policy for Identity.</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;typeparam name=&quot;TUser&quot;&gt;The type that represents a user.&lt;/typeparam&gt;</span><br><span class="line">    public class PasswordValidator&lt;TUser&gt; : IPasswordValidator&lt;TUser&gt; where TUser : class</span><br><span class="line">    &#123;</span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Constructions a new instance of &lt;see cref=&quot;PasswordValidator&#123;TUser&#125;&quot;/&gt;.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;errors&quot;&gt;The &lt;see cref=&quot;IdentityErrorDescriber&quot;/&gt; to retrieve error text from.&lt;/param&gt;</span><br><span class="line">        public PasswordValidator(IdentityErrorDescriber errors = null)</span><br><span class="line">        &#123;</span><br><span class="line">            Describer = errors ?? new IdentityErrorDescriber();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Gets the &lt;see cref=&quot;IdentityErrorDescriber&quot;/&gt; used to supply error text.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;value&gt;The &lt;see cref=&quot;IdentityErrorDescriber&quot;/&gt; used to supply error text.&lt;/value&gt;</span><br><span class="line">        public IdentityErrorDescriber Describer &#123; get; private set; &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Validates a password as an asynchronous operation.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;manager&quot;&gt;The &lt;see cref=&quot;UserManager&#123;TUser&#125;&quot;/&gt; to retrieve the &lt;paramref name=&quot;user&quot;/&gt; properties from.&lt;/param&gt;</span><br><span class="line">        /// &lt;param name=&quot;user&quot;&gt;The user whose password should be validated.&lt;/param&gt;</span><br><span class="line">        /// &lt;param name=&quot;password&quot;&gt;The password supplied for validation&lt;/param&gt;</span><br><span class="line">        /// &lt;returns&gt;The task object representing the asynchronous operation.&lt;/returns&gt;</span><br><span class="line">        public virtual Task&lt;IdentityResult&gt; ValidateAsync(UserManager&lt;TUser&gt; manager, TUser user, string password)</span><br><span class="line">        &#123;</span><br><span class="line">            if (password == null)</span><br><span class="line">            &#123;</span><br><span class="line">                throw new ArgumentNullException(nameof(password));</span><br><span class="line">            &#125;</span><br><span class="line">            if (manager == null)</span><br><span class="line">            &#123;</span><br><span class="line">                throw new ArgumentNullException(nameof(manager));</span><br><span class="line">            &#125;</span><br><span class="line">            var errors = new List&lt;IdentityError&gt;();</span><br><span class="line">            var options = manager.Options.Password;</span><br><span class="line">            if (string.IsNullOrWhiteSpace(password) || password.Length &lt; options.RequiredLength)</span><br><span class="line">            &#123;</span><br><span class="line">                errors.Add(Describer.PasswordTooShort(options.RequiredLength));</span><br><span class="line">            &#125;</span><br><span class="line">            if (options.RequireNonAlphanumeric &amp;&amp; password.All(IsLetterOrDigit))</span><br><span class="line">            &#123;</span><br><span class="line">                errors.Add(Describer.PasswordRequiresNonAlphanumeric());</span><br><span class="line">            &#125;</span><br><span class="line">            if (options.RequireDigit &amp;&amp; !password.Any(IsDigit))</span><br><span class="line">            &#123;</span><br><span class="line">                errors.Add(Describer.PasswordRequiresDigit());</span><br><span class="line">            &#125;</span><br><span class="line">            if (options.RequireLowercase &amp;&amp; !password.Any(IsLower))</span><br><span class="line">            &#123;</span><br><span class="line">                errors.Add(Describer.PasswordRequiresLower());</span><br><span class="line">            &#125;</span><br><span class="line">            if (options.RequireUppercase &amp;&amp; !password.Any(IsUpper))</span><br><span class="line">            &#123;</span><br><span class="line">                errors.Add(Describer.PasswordRequiresUpper());</span><br><span class="line">            &#125;</span><br><span class="line">            if (options.RequiredUniqueChars &gt;= 1 &amp;&amp; password.Distinct().Count() &lt; options.RequiredUniqueChars)</span><br><span class="line">            &#123;</span><br><span class="line">                errors.Add(Describer.PasswordRequiresUniqueChars(options.RequiredUniqueChars));</span><br><span class="line">            &#125;</span><br><span class="line">            return</span><br><span class="line">                Task.FromResult(errors.Count == 0</span><br><span class="line">                    ? IdentityResult.Success</span><br><span class="line">                    : IdentityResult.Failed(errors.ToArray()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Returns a flag indicating whether the supplied character is a digit.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;c&quot;&gt;The character to check if it is a digit.&lt;/param&gt;</span><br><span class="line">        /// &lt;returns&gt;True if the character is a digit, otherwise false.&lt;/returns&gt;</span><br><span class="line">        public virtual bool IsDigit(char c)</span><br><span class="line">        &#123;</span><br><span class="line">            return c &gt;= &apos;0&apos; &amp;&amp; c &lt;= &apos;9&apos;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Returns a flag indicating whether the supplied character is a lower case ASCII letter.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;c&quot;&gt;The character to check if it is a lower case ASCII letter.&lt;/param&gt;</span><br><span class="line">        /// &lt;returns&gt;True if the character is a lower case ASCII letter, otherwise false.&lt;/returns&gt;</span><br><span class="line">        public virtual bool IsLower(char c)</span><br><span class="line">        &#123;</span><br><span class="line">            return c &gt;= &apos;a&apos; &amp;&amp; c &lt;= &apos;z&apos;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Returns a flag indicating whether the supplied character is an upper case ASCII letter.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;c&quot;&gt;The character to check if it is an upper case ASCII letter.&lt;/param&gt;</span><br><span class="line">        /// &lt;returns&gt;True if the character is an upper case ASCII letter, otherwise false.&lt;/returns&gt;</span><br><span class="line">        public virtual bool IsUpper(char c)</span><br><span class="line">        &#123;</span><br><span class="line">            return c &gt;= &apos;A&apos; &amp;&amp; c &lt;= &apos;Z&apos;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// Returns a flag indicating whether the supplied character is an ASCII letter or digit.</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;c&quot;&gt;The character to check if it is an ASCII letter or digit.&lt;/param&gt;</span><br><span class="line">        /// &lt;returns&gt;True if the character is an ASCII letter or digit, otherwise false.&lt;/returns&gt;</span><br><span class="line">        public virtual bool IsLetterOrDigit(char c)</span><br><span class="line">        &#123;</span><br><span class="line">            return IsUpper(c) || IsLower(c) || IsDigit(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>默认的实现类，除了实现了ValidateAsync方法，还有IsDigit IsLower等方法，他们对应了密码配置的属性，比如是否小写，是否大写等等…密码验证方法里面主要根据应用设置的密码强度属性来进行一次判断，代码比较好理解。</p>
<hr>
<h3 id="自定义实现密码强度验证"><a href="#自定义实现密码强度验证" class="headerlink" title="自定义实现密码强度验证"></a>自定义实现密码强度验证</h3><p>虽然内置的密码验证已经满足了大部分应用场景，但有的时候我们还是需要自定义实现一个满足自身业务需求的密码验证类。这里我给大家演示一下怎么去自定义个密码验证类去满足令人头疼业务需求。假设我们有这样一个业务需求：</p>
<ul>
<li>要求密码不能包含敏感字符：china<br>1.首先在项目中创建一个Infrastructure 文件夹，在该文件夹添加一个CustomPasswordValidator类，代码如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">namespace DemoUser.Infrastructure</span><br><span class="line">&#123;</span><br><span class="line">    public class CustomPasswordValidator : PasswordValidator&lt;AppUser&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        public override async Task&lt;IdentityResult&gt; ValidateAsync(</span><br><span class="line">            UserManager&lt;AppUser&gt; manager, AppUser user, string password)</span><br><span class="line">        &#123;</span><br><span class="line">            IdentityResult result = await base.ValidateAsync(manager,</span><br><span class="line">                user, password);</span><br><span class="line">            List&lt;IdentityError&gt; errors = result.Succeeded ? new List&lt;IdentityError&gt;() : result.Errors.ToList();</span><br><span class="line"></span><br><span class="line">            if (password.Contains(&quot;china&quot;))</span><br><span class="line">            &#123;</span><br><span class="line">                errors.Add(new IdentityError</span><br><span class="line">                &#123;</span><br><span class="line">                    Code = &quot;PasswordContainsillegalletter&quot;,</span><br><span class="line">                    Description = &quot;Password cannot contain china&quot;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return errors.Count == 0</span><br><span class="line">                ? IdentityResult.Success</span><br><span class="line">                : IdentityResult.Failed(errors.ToArray());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>2.再次我们需要在startup类里面把我们自定义的密码验证类依赖注入到应用中，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public void ConfigureServices(IServiceCollection services)</span><br><span class="line">        &#123;</span><br><span class="line">            //注入自定义密码验证类</span><br><span class="line">            services.AddTransient&lt;IPasswordValidator&lt;AppUser&gt;,</span><br><span class="line">                CustomPasswordValidator&gt;();</span><br><span class="line">            </span><br><span class="line">            services.AddDbContext&lt;AppIdentityDbContext&gt;(options =&gt;</span><br><span class="line">                options.UseSqlServer(</span><br><span class="line">                    Configuration[&quot;Data:AppStoreIdentity:ConnectionString&quot;]));</span><br><span class="line">            //配置密码强度</span><br><span class="line">            services.AddIdentity&lt;AppUser, IdentityRole&gt;(opts =&gt; &#123;</span><br><span class="line">                    opts.Password.RequiredLength = 6;</span><br><span class="line">                    opts.Password.RequireNonAlphanumeric = false;</span><br><span class="line">                    opts.Password.RequireLowercase = false;</span><br><span class="line">                    opts.Password.RequireUppercase = false;</span><br><span class="line">                    opts.Password.RequireDigit = false;</span><br><span class="line">                &#125;).AddEntityFrameworkStores&lt;AppIdentityDbContext&gt;()</span><br><span class="line">                .AddDefaultTokenProviders();</span><br><span class="line">            services.AddMvc();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这样我们的自定义的密码验证类就成功替换掉了内置的密码验证类。</li>
</ul>
<hr>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>简单介绍了IPasswordValidator的配置和简单自定义，下一篇我打算讲解一下Identity架构的设计，以及我们可以自定义的地方有哪些。<br>代码对应的地址 <a href="https://github.com/bluetianx/AspnetCoreExample">github</a> 对应分支f3</p>

                        
          </div>
          <footer class="article-footer">
            <a data-url="https://github.com/bluetianx/2018/04/07/Identity3/" data-id="cjfp5a4fl0000uhs6vii28262" class="article-share-link">
              Share
            </a>
            
                <!-- 来必力City版安装代码 -->
                <div id="lv-container" data-id="city" data-uid="MTAyMC8zNTUyMS8xMjA1Nw==">
                  <script type="text/javascript">
                    (function (d, s) {
                      var j, e = d.getElementsByTagName(s)[0];

                      if (typeof LivereTower === 'function') { return; }

                      j = d.createElement(s);
                      j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                      j.async = true;

                      e.parentNode.insertBefore(j, e);
                    })(document, 'script');
                  </script>
                  <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
                </div>
                <!-- City版安装代码已完成 -->
                
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Asp-net-core-Identity/">Asp.net core Identity</a></li></ul>

          </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2018/04/04/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

      
</article>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/04/07/Identity3/">深入理解Aspnet Core之Identity(3)</a>
          </li>
        
          <li>
            <a href="/2018/04/04/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Asp-net-Core/">Asp.net Core</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Asp-net-core-Identity/">Asp.net core Identity</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Asp-net-core-Identity/" style="font-size: 10px;">Asp.net core Identity</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Bruce Tian<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="https://github.com/bluetianx" class="mobile-nav-link">Github</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>